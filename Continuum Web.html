<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MPE Continuum Controller PRO</title>
    <style>
        body { margin: 0; background: #0a0a0a; color: #ff3333; font-family: 'Segoe UI', sans-serif; overflow: hidden; touch-action: none; }
        
        /* Dashboard a scomparsa */
        #ui { 
            position: absolute; top: 0; left: 0; right: 0; 
            background: rgba(15, 15, 15, 0.95); padding: 10px 20px; 
            border-bottom: 2px solid #4a1010; display: flex; gap: 20px; 
            z-index: 100; transform: translateY(-85%); transition: 0.3s; 
        }
        #ui:hover { transform: translateY(0); }
        
        .box { display: flex; flex-direction: column; min-width: 100px; }
        label { font-size: 9px; text-transform: uppercase; color: #888; margin-bottom: 4px; }
        select, input { background: #222; color: #ff3333; border: 1px solid #444; padding: 4px; font-size: 12px; border-radius: 3px; outline: none; }
        
        canvas { display: block; width: 100vw; height: 100vh; cursor: crosshair; }
        #debug-info { position: absolute; bottom: 10px; right: 10px; font-size: 10px; color: #444; pointer-events: none; }
    </style>
</head>
<body>

<div id="ui">
    <div class="box"><label>MIDI Output Device</label><select id="midiOutSelect"></select></div>
    <div class="box"><label>Pitch Bend Range (st)</label><input type="number" id="pbRange" value="48"></div>
    <div class="box"><label>Base Note (MIDI)</label><input type="number" id="baseNote" value="48"></div>
    <div id="status" style="margin-top: 15px; font-size: 10px;">Inizializzazione...</div>
</div>

<canvas id="surface"></canvas>
<div id="debug-info">Premi F12 per Console Log | MPE Standard</div>

<script>
/**
 * ARCHITETTURA DI TRASMISSIONE MPE
 */
const canvas = document.getElementById('surface');
const ctx = canvas.getContext('2d');
let midiOutput = null;

const activeVoices = new Map(); // pointerId -> { chan, note, color, x, y, press }
const mpeChannels = Array.from({length: 15}, (_, i) => i + 2); // Canali 2-16

// Inizializzazione MIDI
function setupMIDI() {
    if (navigator.requestMIDIAccess) {
        navigator.requestMIDIAccess().then(access => {
            const outputs = Array.from(access.outputs.values());
            const select = document.getElementById('midiOutSelect');
            select.innerHTML = outputs.map(o => `<option value="${o.id}">${o.name}</option>`).join('');
            midiOutput = outputs[0] || null;
            if(midiOutput) document.getElementById('status').innerText = "MIDI READY: " + midiOutput.name;
            select.onchange = () => midiOutput = access.outputs.get(select.value);
        });
    } else {
        document.getElementById('status').innerText = "Browser non supporta Web MIDI";
    }
}

// Calcolo parametri MPE
function calculateMPE(x, y, pressure) {
    const base = parseInt(document.getElementById('baseNote').value) || 48;
    const pbRange = parseInt(document.getElementById('pbRange').value) || 48;
    const totalNotes = 24; // 2 ottave

    const exactNote = base + (x / canvas.width) * totalNotes;
    const roundedNote = Math.round(exactNote);
    const detune = exactNote - roundedNote;

    // Pitch Bend a 14-bit (8192 Ã¨ il centro)
    const pbValue = Math.floor(8192 + (detune * (8192 / pbRange)));
    // Slide (CC74)
    const slideValue = Math.floor((1 - (y / canvas.height)) * 127);
    // Pressure (se assente, 0.5 per mouse)
    const pressValue = Math.floor((pressure || 0.5) * 127);

    return { roundedNote, pbValue, slideValue, pressValue, x, y };
}

// Gestione Pointer Events (Mouse + Touch)
canvas.addEventListener('pointerdown', e => {
    const channel = mpeChannels.shift();
    if (!channel || !midiOutput) return;

    const m = calculateMPE(e.clientX, e.clientY, e.pressure);
    
    // Sequenza MPE: CC74 -> PitchBend -> NoteOn
    midiOutput.send([0xB0 + channel - 1, 74, m.slideValue]);
    midiOutput.send([0xE0 + channel - 1, m.pbValue & 0x7F, (m.pbValue >> 7) & 0x7F]);
    midiOutput.send([0x90 + channel - 1, m.roundedNote, 100]);

    activeVoices.set(e.pointerId, { 
        chan: channel, 
        note: m.roundedNote, 
        color: `hsl(${channel * 24}, 100%, 60%)`,
        ...m 
    });
    
    console.log(`Note On: CH ${channel} | Note: ${m.roundedNote}`);
});

canvas.addEventListener('pointermove', e => {
    const v = activeVoices.get(e.pointerId);
    if (!v || !midiOutput) return;

    const m = calculateMPE(e.clientX, e.clientY, e.pressure);
    
    // Aggiornamento continuo
    midiOutput.send([0xE0 + v.chan - 1, m.pbValue & 0x7F, (m.pbValue >> 7) & 0x7F]);
    midiOutput.send([0xB0 + v.chan - 1, 74, m.slideValue]);
    midiOutput.send([0xD0 + v.chan - 1, m.pressValue]); // Channel Pressure

    Object.assign(v, m); // Aggiorna posizione per grafica
    console.log(`Glide CH ${v.chan}: PB Value ${m.pbValue}`); // Debug Glide
});

canvas.addEventListener('pointerup', e => {
    const v = activeVoices.get(e.pointerId);
    if (!v || !midiOutput) return;

    midiOutput.send([0x80 + v.chan - 1, v.note, 0]); // Note Off
    mpeChannels.push(v.chan);
    mpeChannels.sort((a, b) => a - b);
    activeVoices.delete(e.pointerId);
});

/**
 * RENDER GRAFICO (ASPETTO CONTINUUM)
 */
function draw() {
    // Sfondo Continuum (Rosso scuro)
    const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
    gradient.addColorStop(0, '#1a0505'); gradient.addColorStop(0.5, '#2b0a0a'); gradient.addColorStop(1, '#1a0505');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    const noteWidth = canvas.width / 24;
    const base = parseInt(document.getElementById('baseNote').value) || 48;

    // Marcatori Tastiera
    for (let i = 0; i <= 24; i++) {
        const x = i * noteWidth;
        const currentNote = (base + i) % 12;
        
        ctx.lineWidth = (currentNote === 0) ? 3 : 1;
        ctx.strokeStyle = (currentNote === 0) ? '#ff3333' : 'rgba(255,255,255,0.1)';
        
        ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); ctx.stroke();
    }

    // Cerchi Colorati (Feedback visivo per dito/mouse)
    activeVoices.forEach(v => {
        ctx.shadowBlur = 40;
        ctx.shadowColor = v.color;
        ctx.fillStyle = v.color;
        
        ctx.beginPath();
        // Dimensione del cerchio basata sulla pressione
        ctx.arc(v.x, v.y, 35 + (v.pressValue / 3), 0, Math.PI * 2);
        ctx.fill();
        
        // Indicatore Canale MIDI
        ctx.shadowBlur = 0;
        ctx.fillStyle = "rgba(255,255,255,0.8)";
        ctx.font = "bold 13px Arial";
        ctx.fillText(`CH ${v.chan}`, v.x - 18, v.y - 70);
    });

    requestAnimationFrame(draw);
}

window.onresize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
window.onresize();
setupMIDI();
draw();
</script>
</body>
</html>